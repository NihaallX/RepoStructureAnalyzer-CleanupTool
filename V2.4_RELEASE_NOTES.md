# V2.4.0 Release Notes: Confidence Score and Git Awareness

**Release Date:** December 2025  
**Type:** Advisory Intelligence Enhancement (Phase 3.2 & 3.3)  
**Status:** âœ… Complete - All 140 tests passing

## Overview

V2.4.0 adds two critical advisory features that help users make informed decisions:
1. **Confidence Score** - Single HIGH/MEDIUM/LOW verdict with explainable reasons
2. **Git Awareness** - Read-only Git status checks with uncommitted change warnings

These features aggregate all safety signals into clear, actionable guidance without blocking execution.

## Key Features

### ðŸ“Š Confidence Scoring (Phase 3.2)

**What It Does:**
- Computes a single confidence level per run: HIGH / MEDIUM / LOW
- Considers multiple signals:
  - Repository type (python_dominant vs non_python)
  - Number and risk levels of MOVE proposals
  - Import breakage warnings count
  - Test file presence
  - Dry-run vs execute mode
- Provides explainable factors (âœ” positives, âš  risks)

**Example Output:**
```
============================================================
ðŸ“Š REORGANIZATION CONFIDENCE: MEDIUM
============================================================

Positive factors:
  âœ” Python-dominant repository
  âœ” Tests detected (easier to validate changes)
  âœ” No import breakage warnings

Risk factors:
  âš  12 medium-risk moves
  âš  Large number of changes (25 moves)

Interpretation: Review changes carefully before applying.
============================================================
```

**Scoring Logic:**
- Starts at score 100
- Penalties:
  - Non-Python repo: -30
  - High-risk moves: -20 each (capped at 60)
  - Medium-risk moves >5: -15, >10: -25
  - Import warnings: -10 each (capped at 30)
  - No tests: -10
  - >20 moves: -15
- Bonus:
  - Dry-run mode: +5
- Thresholds:
  - â‰¥70: HIGH
  - â‰¥40: MEDIUM
  - <40: LOW

### ðŸ”€ Git Awareness (Phase 3.3)

**What It Does:**
- Detects if repository is Git-managed (.git directory)
- Checks for uncommitted changes (git status --porcelain)
- Identifies Git-tracked files in MOVE proposals
- Shows advisory warnings only - NO Git modifications

**Example Output:**
```
============================================================
ðŸ”€ GIT AWARENESS (Read-Only)
============================================================

âš  Uncommitted changes detected
    - src/main.py
    - src/utils.py
    - tests/test_main.py
    ... and 5 more

âš  8 files to move are Git-tracked
    - src/config.py
    - src/models.py
    - src/helpers.py
    - src/constants.py
    - src/validators.py

â„¹ Recommendation: Run `git status` and commit changes before
  applying reorganization. This tool does NOT run `git mv`.
============================================================
```

**Safety Features:**
- Read-only operations (no git mv, no commits)
- Graceful handling of git not installed
- Timeout protection (5s limit)
- Cached results for performance
- No execution blocking

## Technical Implementation

### New Module: `src/confidence.py`
```python
# Three main classes:
- ConfidenceLevel (enum): HIGH, MEDIUM, LOW
- ConfidenceScore: Main scoring engine
  - _calculate_confidence(): Score calculation with simple thresholds
  - _collect_factors(): Explainability - positive and risk factors
  - to_text(): Formatted output with interpretation
  - get_summary(): Dictionary export for programmatic use
```

### New Module: `src/git_detector.py`
```python
# Three main classes:
- GitWarning: Represents Git-related warnings
- GitDetector: Main Git awareness engine
  - is_git_repository(): Checks for .git directory
  - get_uncommitted_files(): Uses `git status --porcelain`
  - is_file_tracked(): Checks `git ls-files`
  - analyze_proposals(): Detects risks in MOVE proposals
  - render_warnings(): Formatted text output
```

### Updated Modules

**1. `src/visualizer.py`**
- Added ConfidenceScore and GitDetector imports
- Enhanced `__init__` with new parameters:
  - `repo_type`: For confidence scoring
  - `has_tests`: For confidence scoring
  - `is_dry_run`: For confidence scoring
- New methods:
  - `generate_confidence_score()`: Creates cached ConfidenceScore
  - `render_confidence_score()`: Formats confidence as text
  - `generate_git_warnings()`: Creates cached Git warnings
  - `render_git_warnings()`: Formats Git warnings as text

**2. `src/cli.py`**
- **Preview command:**
  - Passes repo_type, has_tests, is_dry_run to visualizer
  - Displays confidence score after tree diff
  - Displays Git warnings if Git repo
- **Apply command:**
  - Passes repo_type, has_tests, is_dry_run to visualizer
  - Shows confidence score before execution
  - Shows Git warnings before execution
- Version bumped to 2.4.0

### Test Coverage

**New Tests:**
- **13 tests** in `tests/test_confidence.py`:
  - High/medium/low confidence scenarios
  - Repo type impact
  - Risk level impact
  - Import warnings impact
  - Test presence impact
  - Many moves impact
  - Edge cases (None repo_type, execute mode)
  
- **18 tests** in `tests/test_git_detector.py`:
  - Git repository detection
  - Uncommitted file detection
  - File tracking status
  - Proposal analysis
  - Warning rendering
  - Edge cases (git not installed, timeout, non-Git repos)

**Total: 140 tests passing** (109 existing + 13 confidence + 18 git)

## Integration

### Preview Command
```bash
$ repo-tool preview

[Impact summary]
[Tree diff]
[Import warnings]  # V2.3
[Git warnings]     # V2.4 NEW
[Confidence score] # V2.4 NEW

Next steps:
  1. Run 'repo-tool apply --execute'...
```

### Apply Command
```bash
$ repo-tool apply . --execute

[Impact summary]
[Import warnings]  # V2.3
[Git warnings]     # V2.4 NEW
[Confidence score] # V2.4 NEW

[EXECUTE] Found 10 MOVE proposals
[WARNING] EXECUTE mode - will modify filesystem!
Continue? [y/N]:
```

## Design Principles

âœ… **Advisory, Not Blocking** - All warnings are informational only  
âœ… **Explainable** - Clear reasons for every verdict  
âœ… **Read-Only** - No Git modifications, no filesystem writes  
âœ… **Simple Heuristics** - No AI, just threshold-based logic  
âœ… **Comprehensive** - Aggregates all safety signals  
âœ… **Fast** - Cached results, timeout protection  

## Use Cases

### High Confidence Scenario
```
ðŸ“Š REORGANIZATION CONFIDENCE: HIGH

Positive factors:
  âœ” Python-dominant repository
  âœ” Tests detected
  âœ” Small number of changes (3 moves)
  âœ” All moves are low-risk
  âœ” No import breakage warnings
  âœ” Dry-run mode

Interpretation: Changes appear safe to apply.
```

### Low Confidence Scenario
```
ðŸ“Š REORGANIZATION CONFIDENCE: LOW

Risk factors:
  âš  Non-Python repository (higher risk)
  âš  5 high-risk moves
  âš  15 medium-risk moves
  âš  8 potential import breakage(s)
  âš  No tests detected (harder to validate)
  âš  Large number of changes (30 moves)

Interpretation: High risk - consider smaller batches or manual review.
```

## Breaking Changes

**None** - Fully backward compatible:
- Existing visualizer usage works (new params are optional)
- All existing tests pass without modification
- Git awareness gracefully handles non-Git repos
- Confidence scoring works without repo_type

## Migration Guide

No migration required. V2.4.0 is a drop-in replacement for V2.3.0.

Optional: If using TreeDiffVisualizer programmatically, you can now pass:
```python
visualizer = TreeDiffVisualizer(
    proposals, 
    current_files,
    repo_path=Path("/path/to/repo"),
    enable_import_check=True,
    repo_type=reasoner.repo_type,  # NEW
    has_tests=has_tests,           # NEW
    is_dry_run=True                # NEW
)
```

## Performance Impact

- **Minimal**: Confidence scoring is O(n) on proposals
- **Git operations**: Cached after first call, 5s timeout protection
- **Typical overhead**: <50ms for confidence + git checks
- **No blocking**: All operations are non-blocking

## Limitations

- **Confidence scoring**: Uses simple thresholds (no ML/AI)
- **Git detection**: Windows/Linux/Mac compatible, requires git installed
- **Git operations**: Read-only only (users must run git mv manually)
- **Caching**: Per-visualizer instance (re-creates visualizer = re-analyzes)

## Future Enhancements (Not in V2.4)

Potential future work:
- Machine learning-based confidence scoring
- Git integration (optional git mv support)
- Confidence score history tracking
- Custom confidence threshold configuration
- Integration with CI/CD pipelines

## Acknowledgments

This feature addresses user feedback about:
- "Too much information to process manually"
- "Don't know if it's safe to execute"
- "Forgot to commit before reorganizing"
- "Need one clear verdict"

The confidence score and Git awareness provide the missing "safety verdict" layer that helps users make informed decisions with less cognitive load.

---

**Full Test Results:**
```
140 passed in 3.80s
- 109 existing tests (all pass - no regressions)
- 13 new confidence tests
- 18 new git detector tests
```

**Files Changed:**
- `src/confidence.py` (new, 205 lines)
- `src/git_detector.py` (new, 230 lines)
- `src/visualizer.py` (enhanced, +90 lines)
- `src/cli.py` (enhanced, version 2.4.0)
- `tests/test_confidence.py` (new, 260 lines)
- `tests/test_git_detector.py` (new, 340 lines)
